---
title: "Adjusting for Seasonal Unemployment"
author: "Xavier Humphrey"
date: "2025-08-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r Packages, echo=FLASE}
install.packages("vroom")
install.packages("seasonal")
install.packages("dplyr")
install.packages("ggplot2")
install.packages("readr")
install.packages("x13binary")
install.packages("gridExtra")
install.packages("zoo")
library(seasonal) 
library(dplyr)
library(ggplot2)
library(readr)
library(x13binary)
library(vroom)
library(seasonalview)
library(gridExtra)
library(zoo)
seasonal::checkX13()
x13binary::checkX13binary()
```



```{r Loading Data, echo=FALSE}
setwd("C:/Users/Xhump/OneDrive/Desktop/United States Unemployment")

nwhtun <- "nwht_unemployment_nonadjusted.csv"
library(readr)
raw <- read_csv(nwhtun, show_col_types = FALSE)
print(raw)
# Harmonize to a monthly ts object with frequency = 12 -------------------------
# Adjust this block depending on your file structure
if (all(c("Year", "MonthNum", "UnemploymentRate") %in% names(raw))) {
  raw <- raw %>% mutate(date = as.Date(sprintf("%04d-%02d-01", Year, MonthNum))) %>% arrange(date)
  start_year <- min(raw$Year)
  start_month <- min(raw$MonthNum[raw$Year == start_year])
  ts_data <- ts(raw$UnemploymentRate, start = c(start_year, start_month), frequency = 12)
} else {
  stop("CSV must contain (Year,MonthNum,UnemploymentRate) columns.")
}
```


```{r Runing regARIMA + X-11 with BLS-like defaults, echo=FALSE}

# Key Default elements of BLS:
# - Automatic ARIMA model selection (let X-13 pick)
# - Trading day and moving holiday (Easter) effects included if statistically warranted
# - Outlier detection for AO/LS/TC
# - X-11 decomposition (instead of SEATS) with multiplicative mode

sa <- seas(
  x = ts_data,
  transform.function = "log",                # log transform for rates
  regression.aictest = c("td", "easter"),   # Trading day / Easter if significant
  outlier = NULL,                           # automatic outlier detection
  outlier.types = c("AO", "LS", "TC"),      # Additive outlier, Level shift, Temp change
  x11 = "",                                 # Use X-11 decomposition
  x11.mode = "mult"                         # multiplicative seasonal factors
)


# Extract BLS-style decomposition
sa_series <- series(sa, "d11")       # Seasonally adjusted
trend     <- series(sa, "d12")       # Trend-cycle
irregular <- series(sa, "d13")       # Irregular
seasonal  <- series(sa, "d10")       # Seasonal factors

# Plot all of them
plot(sa_series, main = "Seasonally Adjusted (SA)", ylab = "Percent")
plot(trend, main = "Trend-Cycle", ylab = "Percent")
plot(seasonal, main = "Seasonal Factors", ylab = "Multiplier")
plot(irregular, main = "Irregular Component", ylab = "Residual")

```

```{r Extracting My Seasonally Adjusted Data}
library(zoo)  # for as.yearmon

# Convert ts index to Date
sa_df <- data.frame(
  date = as.Date(as.yearmon(time(sa_series))),
  SA   = as.numeric(sa_series)
)

# Overlay plot (fixed)
p_overlay <- ggplot() +
  geom_line(data = raw, aes(x = date, y = UnemploymentRate, color = "NSA")) +
  geom_line(data = sa_df, aes(x = date, y = SA, color = "SA")) +
  labs(title = "Nonwhite Unemployment Rate: NSA vs SA",
       x = "Date", y = "Percent", color = "Series") +
  scale_color_manual(values = c("NSA" = "red", "SA" = "blue")) +
  theme_minimal()

print(p_overlay)

# Build SA dataframe from the ts object
sa_df <- data.frame(
  Year  = as.numeric(format(as.Date(as.yearmon(time(sa_series))), "%Y")),
  Month = as.numeric(format(as.Date(as.yearmon(time(sa_series))), "%m")),
  SA    = as.numeric(sa_series)
)

# Add NSA (raw data) â€“ already has Year, MonthNum, and UnemploymentRate
nsa_df <- raw %>%
  mutate(
    Year = Year,
    Month = MonthNum,
    NSA = UnemploymentRate
  ) %>%
  select(Year, Month, NSA)

# Merge NSA + SA on Year & Month
merged_df <- merge(nsa_df, sa_df, by = c("Year", "Month"), all = TRUE)

# Save to CSV
write.csv(merged_df, "Unemployment_NSA_SA.csv", row.names = FALSE)

head(merged_df)

```
```{r Final Unemployment CSV}

nwhtune <- "Unemployment_NSA_SA.csv"
whtune <- "wht_unemployment_adjusted.csv"
blkune <- "blk_unemployment_adjusted.csv"
# Read each dataset
df_nwht <- read_csv(nwhtune) %>%
  rename(MonthNum = Month)   # Rename Month -> MonthNum
df_wht  <- read_csv(whtune)
df_blk  <- read_csv(blkune)

# Merge
merged <- df_nwht %>%
  full_join(df_wht, by = c("Year", "MonthNum")) %>%
  full_join(df_blk, by = c("Year", "MonthNum"))

# Save to CSV
write_csv(merged, "Black_and_White_Unemployment.csv")



```